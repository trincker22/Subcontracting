---
title: "Subcontracting"
output: html_document
date: "2025-08-15"
---

```{r}
rm(list = ls())


```

```{r setup, include=FALSE}

library(tidyverse)
library(haven)
library(readxl)
library(readr)
library(jsonlite)
library(purrr)
library(lubridate)
library(quanteda)  
library(quanteda.textmodels)
library(here)
library(tokenizers)
library(topicmodels)
library(syuzhet)
library(caret)
library(irr)
library(SnowballC)
library(ellmer)
library(data.table)
library(e1071)
library(randomForest)
library(glmnet)
library(stringr)
library(glue)
library(digest)
library(tibble)
library(uuid)
library(scales)

options(scipen = 999)

# sub <- read_dta("M:/Xiaoqing/Subcontracting/forNLP.dta")
# subcontracts <- read_dta("M:/Xiaoqing/Subcontracting/forNLP_2.dta")
# saveRDS(subcontracts, "subcontracts.RDS")
# sub <- read_rds(here("subcontracts.RDS"))

NAICS <- read_excel(here("NAICS.xlsx"))


 # sub <- left_join(sub, NAICS, 
 #       join_by(naics_code)) %>% 
 #       mutate(year = year(date(prime_date)))



# twos <- sub %>% 
#   select(product_or_service_code_descript, subaward_description, naics_title, prime_id_num)

sub <- sub %>%  
  group_by(prime_id) %>% 
  slice_head(n=1) %>% 
  ungroup()

sub <- sub %>% 
  mutate(year = year(date(prime_date))) %>% 
  left_join(NAICS %>% select(naics_code, naics_title), join_by(naics_code))
```

```{r}

summary_data_all <- sub %>%
  group_by(year, naics_code) %>%
  summarise(
    num_contracts = n(),
    avg_contract_value = mean(nom_g, na.rm = TRUE),
    total_contract_value = sum(nom_g, na.rm = TRUE),
    .groups = "drop") %>% 
  left_join(NAICS %>% select(naics_code, naics_title), join_by(naics_code))

top_5_naics_value <- summary_data_all %>%
  group_by(naics_title) %>%
  summarise(total_value = sum(total_contract_value), .groups = "drop") %>%
  arrange(desc(total_value)) %>%
  slice(1:5) %>%
  pull(naics_title)

filtered_summary_top5_value <- summary_data_all %>%
  filter(naics_title %in% top_5_naics_value)

grouped_data_for_shares <- summary_data_all %>%
  mutate(naics_group = ifelse(naics_title %in% top_5_naics_value, naics_title, "Other")) %>%
  group_by(year, naics_group) %>%
  summarise(
    num_contracts_grouped = sum(num_contracts),
    total_contract_value_grouped = sum(total_contract_value),
    .groups = "drop"
  )

yoy_change_data <- filtered_summary_top5_value %>%
  group_by(naics_title) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(
    yoy_num_contracts = 100 * (num_contracts / lag(num_contracts) - 1),
    yoy_total_contract_value = 100 * (total_contract_value / lag(total_contract_value) - 1)
  ) %>%
  ungroup()

overall <- sub %>%
  group_by(year) %>%
  summarise(
    num_contracts = n(),
    total_value   = sum(nom_g, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(year) %>%
  mutate(
    yoy_num = 100 * (num_contracts / lag(num_contracts) - 1),
    yoy_val = 100 * (total_value   / lag(total_value)   - 1)
  )

wrap_legend <- function(x, width = 28) stringr::str_wrap(x, width = width)
legend_guide_bottom <- guides(color = guide_legend(nrow = 2, byrow = TRUE),
                              fill  = guide_legend(nrow = 2, byrow = TRUE))
theme_clean <- theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 10),
        legend.text  = element_text(size = 9),
        axis.text.x  = element_text(angle = 45, hjust = 1))
scale_color_wrapped <- scale_color_discrete(labels = ~ wrap_legend(.x, 28))
scale_fill_wrapped  <- scale_fill_discrete(labels  = ~ wrap_legend(.x, 28))

```

```{r}

overall %>%
  ggplot(aes(x = factor(year), y = num_contracts)) +
  geom_col() +
  labs(title = "Total Number of Contracts Per Year", x = "Year", y = "Number of Contracts") +
  theme_clean


```

```{r}

overall %>%
  ggplot(aes(x = factor(year), y = total_value)) +
  geom_col() +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(title = "Total Value of Contracts Per Year", x = "Year", y = "Total Contract Value ($)") +
  theme_clean


```

```{r}

overall %>%
  filter(!is.na(yoy_num), year >2011) %>%
  ggplot(aes(x = year, y = yoy_num)) +
  geom_line() + geom_point() +
  scale_y_continuous(labels = label_percent(scale = 0.01)) +
  scale_x_continuous(breaks = sort(unique(overall$year))) +
  labs(title = "YoY Change: Number of Contracts", x = "Year", y = "YoY %") +
  theme_clean

```

```{r}

overall %>%
  filter(!is.na(yoy_val), year >2011) %>%
  ggplot(aes(x = year, y = yoy_val)) +
  geom_line() + geom_point() +
  scale_y_continuous(labels = label_percent(scale = 0.01)) +
  scale_x_continuous(breaks = sort(unique(overall$year))) +
  labs(title = "YoY Change: Total Contract Value", x = "Year", y = "YoY %") +
  theme_clean

```

```{r}

yoy_change_data %>%
  filter(year > 2012) %>%
  ggplot(aes(x = year, y = yoy_num_contracts, color = naics_title, group = naics_title)) +
  geom_line() + geom_point() +
  scale_y_continuous(labels = label_percent(scale = 0.01)) +
  scale_x_continuous(breaks = sort(unique(yoy_change_data$year))) +
  labs(title = "YoY % Change in Number of Contracts — Top 5 NAICS",
       x = "Year", y = "YoY %", color = "NAICS Industry Title") +
  scale_color_wrapped + theme_clean + legend_guide_bottom

```

```{r}

yoy_change_data %>%
  filter(year > 2012) %>%
  ggplot(aes(x = year, y = yoy_total_contract_value, color = naics_title, group = naics_title)) +
  geom_line() + geom_point() +
  scale_y_continuous(labels = label_percent(scale = 0.01)) +
  scale_x_continuous(breaks = sort(unique(yoy_change_data$year))) +
  labs(title = "YoY % Change in Total Contract Value — Top 5 NAICS",
       x = "Year", y = "YoY %", color = "NAICS Industry Title") +
  scale_color_wrapped + theme_clean + legend_guide_bottom


```

```{r}

ggplot(filtered_summary_top5_value,
       aes(x = year, y = num_contracts, color = naics_title, group = naics_title)) +
  geom_line() + geom_point() +
  scale_x_continuous(breaks = sort(unique(filtered_summary_top5_value$year))) +
  labs(title = "Number of Contracts Over Time — Top 5 NAICS",
       x = "Year", y = "Number of Contracts", color = "NAICS Industry Title") +
  scale_color_wrapped + theme_clean + legend_guide_bottom


```

```{r}

ggplot(filtered_summary_top5_value,
       aes(x = year, y = avg_contract_value, color = naics_title, group = naics_title)) +
  geom_line() + geom_point() +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  scale_x_continuous(breaks = sort(unique(filtered_summary_top5_value$year))) +
  labs(title = "Average Contract Value Over Time — Top 5 NAICS",
       x = "Year", y = "Average Contract Value", color = "NAICS Industry Title") +
  scale_color_wrapped + theme_clean + legend_guide_bottom


```

```{r}

ggplot(grouped_data_for_shares,
       aes(x = factor(year), y = num_contracts_grouped, fill = naics_group)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = percent) +
  labs(title = "Share of Contract Count by Year (Top 5 vs Other)",
       x = "Year", y = "Share", fill = "NAICS Group") +
  scale_fill_wrapped + theme_clean + legend_guide_bottom

```

```{r}

ggplot(grouped_data_for_shares,
       aes(x = factor(year), y = total_contract_value_grouped, fill = naics_group)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = percent) +
  labs(title = "Share of Contract Value by Year (Top 5 vs Other)",
       x = "Year", y = "Share", fill = "NAICS Group") +
  scale_fill_wrapped + theme_clean + legend_guide_bottom

```

```{r}

theme_clean <- theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 10),
        legend.text  = element_text(size = 9),
        axis.text.x  = element_text(angle = 45, hjust = 1))

sub_prep <- sub %>%
  mutate(prime_date = as.Date(prime_date),
         year = year(prime_date))

summary_data_all <- sub_prep %>%
  group_by(year, naics_title) %>%
  summarise(num_contracts = n(),
            avg_contract_value = mean(nom_g, na.rm = TRUE),
            total_contract_value = sum(nom_g, na.rm = TRUE),
            .groups = "drop")

hhi_by_year <- summary_data_all %>%
  group_by(year, naics_title) %>%
  summarise(val = sum(total_contract_value), .groups = "drop_last") %>%
  mutate(year_total = sum(val),
         share_pct = ifelse(year_total > 0, 100 * val / year_total, NA_real_)) %>%
  summarise(HHI = sum(share_pct^2, na.rm = TRUE), .groups = "drop")

ggplot(hhi_by_year, aes(x = year, y = HHI)) +
  geom_line() + geom_point() +
  labs(title = "Market Concentration (HHI) of Contract Value by Year",
       x = "Year", y = "HHI (0–10,000)") +
  theme_clean

```


The HHI (Herfindahl-Hirschman Index) measures market concentration. HHI is the sum of each industry's % share*100, squared, for each year. If all the shares are small, nearing perfect competition, then the HHI will be close to 0 because the squared shares are very small. If one firm has 100% share, 100^2 will be 10,000, the max HHI value. Below 1,500 is considered not concentrated, while an HHI above 2500 is considered highly concentrated.
We can see here that concentration has decreased since 2010, but largely has not been concentrated. This value only measures the concentration of industries within federal government contracts, it does not say anything about the firm composition within any given industry.  

```{r}

monthly_series <- sub_prep %>%
  mutate(month = floor_date(prime_date, "quarter")) %>%
  group_by(month) %>%
  summarise(total_value = sum(nom_g, na.rm = TRUE), .groups = "drop")

ggplot(monthly_series, aes(x = month, y = total_value)) +
  geom_line() +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(title = "Monthly Total Contract Value Over Time",
       x = "Month", y = "Total Contract Value") +
  theme_clean

```

```{r}
size_vs_count <- summary_data_all %>%
  group_by(naics_title) %>%
  summarise(total_value = sum(total_contract_value, na.rm = TRUE),
            num_contracts = sum(num_contracts, na.rm = TRUE),
            .groups = "drop")

ggplot(size_vs_count, aes(x = num_contracts, y = total_value)) +
  geom_point(alpha = 0.7) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(title = "Contracts: Count vs Total Value by NAICS (All Years)",
       x = "Number of Contracts", y = "Total Contract Value") +
  theme_clean

```

```{r}

chat <- ellmer::chat_google_gemini()

contracts <- sub %>% 
  mutate( 
    obs_id = prime_id_num, 
    broad_cat = product_or_service_code_descript, 
    specific_desc = subaward_description, 
    naics = naics_title
    ) %>% 
  select(obs_id, broad_cat, specific_desc, naics)

prompt_readable <- function(broad, specific) {
  glue(
"{{
  \"task\": \"rewrite_to_plain_english\",
  \"schema\": {{
    \"returned_text\": \"string\",
    \"notes\": \"string\"
  }},
  \"instructions\": \"You are given a general contract category and a specific subaward description. 
  If the description is already human-readable, return it unchanged. 
  If it is code-like or obscure, return a brief plain-English description. 
  Be conservative: no hallucinated details; if in doubt, summarize functionally.\",
  \"category\": \"{broad}\",
  \"description\": \"{specific}\",
  \"output_format\": \"JSON with fields returned_text, notes\"
}}")
}

prompt_relation <- function(broad, specific) {
  glue(
"{{
  \"task\": \"relation_classification\",
  \"schema\": {{
    \"relation\": \"enum[same, subset, unrelated, unclear]\",
    \"rationale\": \"string\"
  }},
  \"instructions\": \"Classify the relationship between the broad category and the subtask.
   same = equivalent meaning; subset = subtask is a specialization of the category;
   unrelated = different domains; unclear = insufficient info.\",
  \"category\": \"{broad}\",
  \"subtask\": \"{specific}\",
  \"output_format\": \"JSON with fields relation, rationale\"
}}")
}


call_chat_safe <- function(prompt, max_tries = 5, base_sleep = 2) {
  for (i in seq_len(max_tries)) {
    out <- try(chat$chat(prompt), silent = TRUE)
    if (!inherits(out, "try-error") && is.character(out) && nchar(out) > 0) return(out)
    Sys.sleep(base_sleep * (2^(i-1)) + runif(1, 0, 0.5))
  }
  NA_character_
}

parse_json_relaxed <- function(txt) {
  if (is.na(txt)) return(tibble::tibble(parsed_ok = FALSE))
  m <- str_match(txt, "\\{[\\s\\S]*\\}$")
  json_txt <- if (!is.na(m[,1])) m[,1] else txt
  out <- try(jsonlite::fromJSON(json_txt), silent = TRUE)
  if (inherits(out, "try-error")) tibble(parsed_ok = FALSE) else cbind(parsed_ok = TRUE, as_tibble(out))
}

# batch runner
run_llm_over_df <- function(df, broad_col, specific_col,
                            which_prompt = c("readable", "relation"),
                            batch_size = 20,
                            checkpoint_path = NULL,
                            temperature = 0.0) {
  which_prompt <- match.arg(which_prompt)


  idx <- split(seq_len(nrow(contracts)), ceiling(seq_along(seq_len(nrow(contracts))) / batch_size))

  results <- vector("list", length(idx))
  for (bi in seq_along(idx)) {
    rows <- contracts[idx[[bi]], ]

    # build prompts and call
    prompts <- pmap(rows, function(obs_id, ...) {
      broad <- rows[[broad_col]][rows$obs_id == obs_id]
      spec  <- rows[[specific_col]][rows$obs_id == obs_id]
      if (which_prompt == "readable") prompt_readable(broad, spec) else prompt_relation(broad, spec)
    })

    raw <- map(prompts, ~ call_chat_safe(.x))

    parsed <- map_dfr(raw, parse_json_relaxed)

    out <- tibble(
      obs_id = rows$obs_id,
      raw = raw
    ) %>%
      bind_cols(parsed)

    results[[bi]] <- out

    # checkpoint
    if (!is.null(checkpoint_path) && (bi %% 5 == 0 || bi == length(idx))) {
      write_rds(bind_rows(results[seq_len(bi)]), checkpoint_path)
    }
  }
  bind_rows(results)
}


if (file.exists(here("readable_checkpoint.rds"))) {
  prev_readable <- read_rds(here("readable_checkpoint.rds"))
} else {
  prev_readable <- tibble(obs_id = double())
}

needs_readable <- anti_join(
  contracts %>% select(obs_id, broad_cat, specific_desc),
  prev_readable %>% select(obs_id),
  by = c("obs_id")
)


readable_new <- if (nrow(needs_readable) > 0) {
  run_llm_over_df(
    needs_readable, "broad_cat", "specific_desc",
    which_prompt = "readable",
    batch_size = 20,
    checkpoint_path = "readable_checkpoint.rds"
  )
} else tibble()

readable_all <- bind_rows(
  prev_readable,
  readable_new
) %>% distinct(obs_id, .keep_all = TRUE)

contracts <- contracts %>%
  left_join(
    readable_all %>%
      transmute(obs_id, readable_text = coalesce(returned_text, NA_character_), readable_notes = notes %||% NA_character_),
    by = "obs_id"
  )

if (file.exists(here("relation_checkpoint.rds"))) {
  prev_rel <- read_rds(here("relation_checkpoint.rds"))
} else {
  prev_rel <- tibble(obs_id = character())
}

needs_rel <- anti_join(
  contracts %>% select(obs_id, broad_cat, specific_desc),
  prev_rel %>% select(obs_id),
  by = c("obs_id")
)

rel_new <- if (nrow(needs_rel) > 0) {
  run_llm_over_df(
    needs_rel, "broad_cat", "specific_desc",
    which_prompt = "relation",
    batch_size = 20,
    checkpoint_path = here("relation_checkpoint.rds")
  )
} else tibble()

rel_all <- bind_rows(prev_rel, rel_new) %>% distinct(obs_id, .keep_all = TRUE)

contracts <- contracts %>%
  left_join(
    rel_all %>% transmute(
      obs_id,
      relation = ifelse(parsed_ok, relation, NA_character_),
      relation_rationale = ifelse(parsed_ok, rationale, NA_character_)
    ),
    by = "obs_id"
  )


```

```{r}


```

```{r}


```

\`\`\`{r}
